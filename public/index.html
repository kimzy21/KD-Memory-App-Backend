<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Our Little Timeline üíï</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/vue@2.7.8/dist/vue.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <link rel="icon" type="image/png" href="/Assets/icon.png">
</head>

<body>
    <div id="app">

        <!-- LOGIN -->
        <section v-if="page === 'login'" class="login">
            <h1>üîê Our Secret</h1>
            <input type="password" v-model="password" placeholder="Enter secret" />
            <button @click="login">Enter üíñ</button>
        </section>

        <!-- NAV -->
        <nav v-if="page !== 'login'">
            <button @click="page='home'">Home</button>
            <button @click="page='album'">Photos</button>
            <button @click="page='timeline'">Timeline</button>
            <button @click="page='notes'">Notes</button>
        </nav>

        <!-- HOME -->
        <section v-if="page === 'home'" class="home">
            <h2>Hi my love üíï</h2>
            <p>I made this for us.</p>
            <p>Every memory here matters to me.</p>
        </section>

        <!-- PHOTO ALBUM -->
        <section v-if="page === 'album'" class="grid">
            <div v-for="p in photos" class="card" @click="openCarousel(p.photos, p.description)">
                <img :src="p.cover" />
                <p>{{ p.title }}</p>
                <small>{{ formatDate(p.date) }}</small>
            </div>
        </section>

        <!-- CAROUSEL MODAL -->
        <div v-if="showCarousel" class="carousel-modal" @click.self="closeCarousel">
            <!-- Close icon (top-right) -->
            <i class="fa-regular fa-circle-xmark close-icon" @click="closeCarousel"></i>
            <img :src="carouselPhotos[currentIndex]" />
            <p class="carousel-description">{{ currentPhotoDescription }}</p>
            <!-- Thumbnails -->
            <div class="carousel-thumbnails">
                <img v-for="(photo, index) in carouselPhotos" :key="index" :src="photo"
                    :class="{ active: index === currentIndex }" @click="currentIndex = index" />
            </div>
            <!-- Navigation Buttons -->
            <div>
                <button @click="prevPhoto">Prev</button>
                <button @click="nextPhoto">Next</button>
            </div>
        </div>

        <!-- TIMELINE -->
        <section v-if="page === 'timeline'" class="timeline-layout">

            <!-- LEFT: Timeline spine -->
            <div class="timeline-left">
                <div class="timeline-wrapper-vertical">
                    <div v-for="(month, index) in timelineMonths" :key="index" class="timeline-dot-vertical"
                        :class="{ active: index === activeMonthIndex }" @click="activeMonthIndex = index">
                        <span class="month-label">{{ month.label }}</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT: Events -->
            <div class="timeline-right">
                <div v-for="event in filteredEvents" :key="event._id" class="timeline-item clickable"
                    :class="{ milestone: event.isMilestone }" @click="openEventModal(event)">

                    <!-- DATE AT TOP -->
                    <div class="timeline-date">
                        {{ formatDate(event.date) }}
                    </div>

                    <h3>{{ event.title }}</h3>

                    <!-- ‚úÖ DESCRIPTION ON THE CARD -->
                    <p v-if="event.description" class="timeline-description"> {{ event.description }}</p>

                    <div v-if="event.images && event.images.length" class="event-images"
                        @click.stop="openCarousel(event.images)">
                        <img v-for="(img, i) in event.images" :key="i" :src="img" />
                    </div>

                </div>
            </div>
        </section>

        <!-- NOTES -->
        <section v-if="page === 'notes'" class="notes">
            <div v-for="n in notes" class="note">
                <strong>{{ n.sender }}</strong>
                <p>{{ n.message }}</p>
                <small>{{ formatDate(n.createdAt) }}</small>
            </div>

            <textarea v-model="newNote" placeholder="Write something cute üíå"></textarea>
            <button @click="sendNote">Send</button>
        </section>

    </div>

    <!-- Inject API URL from server -->
    <script src="/config.js"></script>

    <!-- Map global value to local constant -->
    <script>
      const API = window.API_URL;
    </script>

    <script>
        new Vue({
            el: "#app",
            data: {
                page: "login",
                password: "",
                photos: [],
                timeline: [],
                notes: [],
                newNote: "",
                sender: "Me",
                showCarousel: false,
                carouselPhotos: [],
                currentIndex: 0,
                currentPhotoDescription: "",
                activeMonthIndex: 0,
                timelineMonths: [],
                milestones: []
            },
            created() {
                this.timelineStart = new Date(2025, 9, 1);      // Oct 1, 2025
                this.relationshipStart = new Date(2025, 10, 1); // Nov 1, 2025

                const today = new Date();

                const monthsDiff =
                    (today.getFullYear() - this.timelineStart.getFullYear()) * 12 +
                    (today.getMonth() - this.timelineStart.getMonth()) + 1;

                this.timelineMonths = Array.from({ length: monthsDiff }, (_, i) => {
                    const d = new Date(
                        this.timelineStart.getFullYear(),
                        this.timelineStart.getMonth() + i,
                        1
                    );

                    return {
                        date: d,
                        label: d.toLocaleString("default", { month: "short", year: "numeric" })
                    };
                });
            },
            computed: {
                filteredEvents() {
                    if (!this.timelineMonths.length) return [];

                    const month = this.timelineMonths[this.activeMonthIndex];
                    const monthDate = new Date(month.date);

                    // Normalize dates
                    monthDate.setHours(0, 0, 0, 0);

                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // Normal events for this month
                    const events = this.timeline.filter(event => {
                        const eDate = new Date(event.date);
                        return (
                            eDate.getMonth() === monthDate.getMonth() &&
                            eDate.getFullYear() === monthDate.getFullYear()
                        );
                    });

                    // üö® NO milestones before December 2025
                    const firstMilestoneDate = new Date(2025, 11, 1); // Dec 1, 2025
                    firstMilestoneDate.setHours(0, 0, 0, 0);

                    if (monthDate >= firstMilestoneDate && today >= monthDate) {
                        const monthsTogether =
                            (monthDate.getFullYear() - this.relationshipStart.getFullYear()) * 12 +
                            (monthDate.getMonth() - this.relationshipStart.getMonth());

                        events.unshift({
                            _id: `milestone-${monthsTogether}`,
                            title: `‚ú® ${monthsTogether} month${monthsTogether > 1 ? "s" : ""} together`,
                            date: monthDate,          // ‚úÖ fixes Invalid Date
                            images: [],
                            isMilestone: true
                        });
                    }

                    return events;
                }
            },
            methods: {
                async login() {
                    const res = await fetch(`${API}/login`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ password: this.password })
                    });
                    if (res.ok) {
                        this.page = "home";
                        this.loadAll();
                    } else {
                        alert("Wrong secret üò≠");
                    }
                },
                async loadAll() {
                    this.photos = await (await fetch("/photos")).json();
                    this.timeline = await (await fetch("/timeline")).json();
                    this.notes = await (await fetch("/notes")).json();
                },
                async sendNote() {
                    if (!this.newNote.trim()) return;
                    await fetch("/notes", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            sender: this.sender,
                            message: this.newNote
                        })
                    });
                    this.newNote = "";
                    this.notes = await (await fetch("/notes")).json();
                },
                formatDate(d) {
                    return new Date(d).toDateString();
                },
                openCarousel(photoArray, description = "") {
                    this.carouselPhotos = photoArray;
                    this.currentIndex = 0;
                    this.currentPhotoDescription = description || "";
                    this.showCarousel = true;
                },
                closeCarousel() {
                    this.showCarousel = false;
                    this.carouselPhotos = [];
                    this.currentPhotoDescription = "";
                },
                nextPhoto() {
                    if (this.currentIndex < this.carouselPhotos.length - 1) this.currentIndex++;
                },
                prevPhoto() {
                    if (this.currentIndex > 0) this.currentIndex--;
                }
            }
        });
    </script>
</body>

</html>